(()=>{"use strict";const e=new class{constructor(){this.isEnabled=!0,this.logLevel="info"}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}log(e,t,n){if(!this.isEnabled||!this.shouldLog(e))return;const i={level:e,message:t,data:this.sanitizeData(n),timestamp:(new Date).toISOString(),source:this.getSource()};this.logToConsole(i),"error"!==e&&"warn"!==e||this.sendToBackground(i)}shouldLog(e){const t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(this.logLevel)}sanitizeData(e){if(!e)return e;const t=["password","token","apiKey","secret","email","phone"];if("object"==typeof e){const n={...e};for(const e of Object.keys(n))t.some(t=>e.toLowerCase().includes(t))&&(n[e]="[REDACTED]");return n}return e}getSource(){return"undefined"!=typeof chrome&&chrome.runtime?"extension":"unknown"}logToConsole(e){const t=`[SmartShield ${e.level.toUpperCase()}] ${e.message}`;switch(e.level){case"debug":console.debug(t,e.data);break;case"info":console.info(t,e.data);break;case"warn":console.warn(t,e.data);break;case"error":console.error(t,e.data)}}sendToBackground(e){try{"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage({type:"LOG_ENTRY",payload:e}).catch(()=>{})}catch(e){}}setLevel(e){this.logLevel=e}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}};class t{constructor(){this.rules=[],this.config={},this.checkSuspiciousDomain=e=>{const t=e.url;try{const e=new URL(t).hostname.toLowerCase();return[".tk",".ml",".ga",".cf",".click",".download",".exe"].some(t=>e.endsWith(t))?{matches:!0,score:.8,reason:`Suspicious top-level domain: ${e}`}:["google.com","microsoft.com","apple.com","amazon.com","paypal.com"].some(t=>{const n=this.levenshteinDistance(e,t);return n<=2&&n>0})?{matches:!0,score:.9,reason:`Potential typosquatting: ${e}`}:{matches:!1,score:0}}catch{return{matches:!0,score:.6,reason:"Invalid URL format"}}},this.checkUrlShortener=e=>{const t=e.url,n=["bit.ly","tinyurl.com","t.co","goo.gl","ow.ly","is.gd","short.link","cutt.ly","rebrand.ly","linktr.ee"];try{const e=new URL(t).hostname.toLowerCase();return n.some(t=>e.includes(t))?{matches:!0,score:.3,reason:`URL shortener detected: ${e}`}:{matches:!1,score:0}}catch{return{matches:!1,score:0}}},this.checkSubdomainSpoofing=e=>{const t=e.url;try{const e=new URL(t).hostname.toLowerCase(),n=[/security-/,/verify-/,/account-/,/login-/,/support-/,/microsoft-/,/google-/,/apple-/,/amazon-/,/paypal-/];for(const t of n)if(t.test(e))return{matches:!0,score:.7,reason:`Suspicious subdomain pattern: ${e}`};return{matches:!1,score:0}}catch{return{matches:!1,score:0}}},this.checkIpAddressUrl=e=>{const t=e.url;try{const e=new URL(t).hostname;return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)?{matches:!0,score:.6,reason:`Direct IP address URL: ${e}`}:{matches:!1,score:0}}catch{return{matches:!1,score:0}}},this.checkUrgentLanguage=e=>{const t=e.text.toLowerCase(),n=["urgent","immediate action required","act now","limited time","expires soon","last chance","final notice","account suspended","verify immediately","confirm now","security alert","unauthorized access"].filter(e=>t.includes(e));return n.length>0?{matches:!0,score:Math.min(.8,.2*n.length),reason:`Urgent language detected: ${n.join(", ")}`}:{matches:!1,score:0}},this.checkSensitiveInfoRequest=e=>{const t=e.text.toLowerCase(),n=["password","credit card","social security","ssn","bank account","routing number","pin","cvv","security code","login credentials","username","account number","date of birth","mother maiden name"].filter(e=>t.includes(e));return n.length>0?{matches:!0,score:Math.min(.9,.3*n.length),reason:`Request for sensitive information: ${n.join(", ")}`}:{matches:!1,score:0}},this.checkPoorGrammar=e=>{const t=e.text,n=[/youre\b/g,/dont\b/g,/wont\b/g,/cant\b/g,/\b([A-Z][a-z]+)\s+\1\b/g];let i=0;for(const e of n){const n=t.match(e);n&&(i+=n.length)}return(t.match(/[A-Z]/g)||[]).length/t.length>.3&&(i+=3),i>2?{matches:!0,score:Math.min(.4,.1*i),reason:"Poor grammar/spelling detected"}:{matches:!1,score:0}},this.checkImpersonation=e=>{const t=e.text.toLowerCase(),n=e.url.toLowerCase(),i=["microsoft","google","apple","amazon","paypal","netflix","facebook","instagram","twitter","linkedin","dropbox"].filter(e=>t.includes(e));return i.length>0&&!i.some(e=>n.includes(e))?{matches:!0,score:.8,reason:`Brand impersonation detected: ${i.join(", ")}`}:{matches:!1,score:0}},this.checkSuspiciousAttachments=e=>{const t=e.text.toLowerCase(),n=[".exe",".scr",".bat",".cmd",".com",".pif",".vbs",".js"].filter(e=>t.includes(e));return n.length>0?{matches:!0,score:.9,reason:`Suspicious file attachments: ${n.join(", ")}`}:{matches:!1,score:0}},this.checkSuspiciousHeaders=e=>{const t=e.headers.join("\n").toLowerCase(),n=["x-priority: 1","x-msmail-priority: high","x-mailer:","x-originating-ip:"].filter(e=>t.includes(e));return n.length>0?{matches:!0,score:.4,reason:`Suspicious headers: ${n.join(", ")}`}:{matches:!1,score:0}},this.checkReplyToMismatch=e=>({matches:!1,score:0}),this.initializeRules()}initializeRules(){this.rules.push({name:"suspicious_domain",description:"Check for suspicious or newly registered domains",weight:.3,check:this.checkSuspiciousDomain}),this.rules.push({name:"url_shortener",description:"Detect URL shorteners that may hide malicious links",weight:.2,check:this.checkUrlShortener}),this.rules.push({name:"subdomain_spoofing",description:"Detect subdomain spoofing attempts",weight:.4,check:this.checkSubdomainSpoofing}),this.rules.push({name:"ip_address_url",description:"Detect direct IP address URLs",weight:.3,check:this.checkIpAddressUrl}),this.rules.push({name:"urgent_language",description:"Detect urgent or threatening language",weight:.3,check:this.checkUrgentLanguage}),this.rules.push({name:"sensitive_info_request",description:"Detect requests for sensitive information",weight:.5,check:this.checkSensitiveInfoRequest}),this.rules.push({name:"poor_grammar_spelling",description:"Detect poor grammar and spelling",weight:.2,check:this.checkPoorGrammar}),this.rules.push({name:"impersonation_indicators",description:"Detect brand impersonation attempts",weight:.4,check:this.checkImpersonation}),this.rules.push({name:"suspicious_attachments",description:"Detect suspicious file attachments",weight:.3,check:this.checkSuspiciousAttachments}),this.rules.push({name:"suspicious_headers",description:"Analyze email headers for spoofing indicators",weight:.3,check:this.checkSuspiciousHeaders}),this.rules.push({name:"reply_to_mismatch",description:"Check for reply-to address mismatches",weight:.2,check:this.checkReplyToMismatch}),e.info(`Initialized ${this.rules.length} phishing detection rules`)}async analyzeContent(t){const n=Date.now();try{e.info("Starting phishing detection",{url:t.url,contentLength:t.text.length,hasForms:t.forms.length>0,hasLinks:t.links.length>0});const i=this.runLocalAnalysis(t),s=this.shouldUseCloudAnalysis(i),o={...i,requiresCloudAnalysis:s,localAnalysis:!0},r=Date.now()-n;return e.info("Phishing detection completed",{score:o.score,label:o.label,duration:`${r}ms`,reasons:o.reasons.length}),o}catch(t){return e.error("Phishing detection failed",{error:t}),{score:.5,label:"suspicious",reasons:["Detection analysis failed"],confidence:.1,localAnalysis:!0,requiresCloudAnalysis:!1,metadata:{}}}}runLocalAnalysis(t){let n=0,i=0;const s=[],o={};for(const r of this.rules)try{const e=r.check(t);e.matches&&(n+=e.score*r.weight,i+=r.weight,e.reason&&s.push(e.reason),this.categorizeScore(r.name,e.score,o))}catch(t){e.warn(`Rule ${r.name} failed:`,t)}const r=i>0?Math.min(1,n/i):0;let a;return a=r>=.8?"phishing":r>=.5?"suspicious":"clean",{score:r,label:a,reasons:s,confidence:Math.min(.9,.3+.1*s.length),localAnalysis:!0,requiresCloudAnalysis:!1,model:"local-heuristics",provider:"local",metadata:o}}shouldUseCloudAnalysis(e){return e.score>=.3&&e.score<=.7&&e.confidence<.7}categorizeScore(e,t,n){e.includes("url")||e.includes("domain")?n.urlScore=(n.urlScore||0)+t:e.includes("content")||e.includes("language")||e.includes("grammar")?n.contentScore=(n.contentScore||0)+t:e.includes("header")||e.includes("email")?n.headerScore=(n.headerScore||0)+t:n.socialEngineeringScore=(n.socialEngineeringScore||0)+t}levenshteinDistance(e,t){const n=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let t=0;t<=e.length;t++)n[0][t]=t;for(let e=0;e<=t.length;e++)n[e][0]=e;for(let i=1;i<=t.length;i++)for(let s=1;s<=e.length;s++){const o=e[s-1]===t[i-1]?0:1;n[i][s]=Math.min(n[i][s-1]+1,n[i-1][s]+1,n[i-1][s-1]+o)}return n[t.length][e.length]}}new t;class n{constructor(){if(this.config={},n.instance)return n.instance;n.instance=this}static async extractContent(){const e=new n;return await e.extractPageContent()}async extractPageContent(){try{e.info("Starting content extraction",{url:window.location.href,title:document.title});const t={url:window.location.href,title:document.title,text:"",forms:[],links:[],images:[],headers:[],timestamp:Date.now(),snapshotHash:""};return t.text=await this.extractTextContent(),t.forms=this.extractForms(),t.links=this.extractLinks(),t.images=this.extractImages(),t.headers=this.extractHeaders(),t.snapshotHash=this.generateSnapshotHash(t),e.info("Content extraction completed",{textLength:t.text.length,formsCount:t.forms.length,linksCount:t.links.length,imagesCount:t.images.length,snapshotHash:t.snapshotHash}),t}catch(t){throw e.error("Failed to extract content",{error:t}),t}}async extractTextContent(){try{document.querySelectorAll("script, style, noscript, iframe").forEach(e=>e.remove());const e=["main",'[role="main"]',"article",".content",".main-content","#content","#main","body"];let t="",n=null;for(const i of e){const e=document.querySelector(i);e&&e.textContent&&e.textContent.length>t.length&&(n=e,t=e.textContent)}return n||(t=document.body.textContent||""),t=this.cleanTextContent(t),!1!==this.config.privacyMode&&(t=function(e){if(!e||"string"!=typeof e)return e;let t=e;return t=t.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,"[EMAIL_REDACTED]"),t=t.replace(/(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/g,"[PHONE_REDACTED]"),t=t.replace(/\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/g,"[PHONE_REDACTED]"),t=t.replace(/\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g,"[CARD_REDACTED]"),t=t.replace(/\b\d{13,19}\b/g,"[CARD_REDACTED]"),t=t.replace(/\b\d{3}-?\d{2}-?\d{4}\b/g,"[SSN_REDACTED]"),t=t.replace(/\b\d{8,17}\b/g,e=>e.length>=8&&e.length<=17?"[ACCOUNT_REDACTED]":e),t=t.replace(/\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,"[IP_REDACTED]"),t}(t)),t}catch(t){return e.error("Failed to extract text content",{error:t}),""}}cleanTextContent(e){return e.replace(/\s+/g," ").replace(/\n\s*\n/g,"\n").trim().substring(0,5e4)}extractForms(){try{const e=[];return document.querySelectorAll("form").forEach(t=>{const n={action:t.action||"",method:t.method.toLowerCase()||"get",inputs:[]};t.querySelectorAll("input, select, textarea").forEach(e=>{const t=e;n.inputs.push({type:t.type||"text",name:t.name||"",placeholder:t.placeholder||void 0,required:t.required||!1})}),e.push(n)}),e}catch(t){return e.error("Failed to extract forms",{error:t}),[]}}extractLinks(){try{const e=[];return document.querySelectorAll("a[href]").forEach(t=>{const n=t,i=n.href;if(i&&"#"!==i){const t={href:i,text:n.textContent?.trim()||"",title:n.title||void 0,isExternal:this.isExternalLink(i)};e.push(t)}}),e}catch(t){return e.error("Failed to extract links",{error:t}),[]}}extractImages(){try{const e=[];return document.querySelectorAll("img[src]").forEach(t=>{const n=t;n.src&&e.push({src:n.src,alt:n.alt||void 0,title:n.title||void 0})}),e}catch(t){return e.error("Failed to extract images",{error:t}),[]}}extractHeaders(){try{const e=[];document.querySelectorAll("meta").forEach(t=>{const n=t;n.name&&n.content&&e.push(`${n.name}: ${n.content}`),n.getAttribute("property")&&n.content&&e.push(`${n.getAttribute("property")}: ${n.content}`)});const t=this.extractHttpHeaders();return e.push(...t),e}catch(t){return e.error("Failed to extract headers",{error:t}),[]}}extractHttpHeaders(){try{const e=[],t=[/from:\s*(.+)/gi,/to:\s*(.+)/gi,/subject:\s*(.+)/gi,/date:\s*(.+)/gi,/reply-to:\s*(.+)/gi],n=document.body.textContent||"";return t.forEach(t=>{const i=n.match(t);i&&e.push(...i)}),e}catch(t){return e.error("Failed to extract HTTP headers",{error:t}),[]}}isExternalLink(e){try{const t=new URL(e),n=new URL(window.location.href);return t.hostname!==n.hostname}catch{return!1}}generateSnapshotHash(t){try{const e={url:t.url,title:t.title,text:t.text.substring(0,1e3),formsCount:t.forms.length,linksCount:t.links.length},n=JSON.stringify(e);let i=0;for(let e=0;e<n.length;e++)i=(i<<5)-i+n.charCodeAt(e),i&=i;return Math.abs(i).toString(36)}catch(t){return e.error("Failed to generate snapshot hash",{error:t}),Date.now().toString(36)}}static async extractEmailContent(){try{if(!n.detectEmailPage())return null;const e=new n,t=await e.extractPageContent();return t.emailData=await e.extractEmailSpecificData(),t}catch(t){return e.error("Failed to extract email content",{error:t}),null}}static detectEmailPage(){try{const e=[/gmail\.com/i,/outlook\.com/i,/yahoo\.com/i,/hotmail\.com/i,/from:\s*.+/i,/to:\s*.+/i,/subject:\s*.+/i,/date:\s*.+/i,/mail/i,/inbox/i,/compose/i,/reply/i,/forward/i],t=window.location.href,n=document.title,i=document.body.textContent||"";return e.some(e=>e.test(t)||e.test(n)||e.test(i))}catch(t){return e.error("Failed to detect email page",{error:t}),!1}}async extractEmailSpecificData(){try{const e={from:"",to:"",subject:"",date:"",replyTo:"",headers:[]},t=document.body.textContent||"",n=t.match(/from:\s*(.+)/i);n&&(e.from=n[1].trim());const i=t.match(/to:\s*(.+)/i);i&&(e.to=i[1].trim());const s=t.match(/subject:\s*(.+)/i);s&&(e.subject=s[1].trim());const o=t.match(/date:\s*(.+)/i);o&&(e.date=o[1].trim());const r=t.match(/reply-to:\s*(.+)/i);return r&&(e.replyTo=r[1].trim()),e}catch(t){return e.error("Failed to extract email-specific data",{error:t}),{}}}}class i{constructor(){this.overlay=null,this.isVisible=!1}show(e,t,n){this.isVisible&&this.hide(),this.createOverlay(e,t,n),this.isVisible=!0}hide(){this.overlay&&(this.overlay.remove(),this.overlay=null,this.isVisible=!1)}createOverlay(e,t,n){this.overlay=document.createElement("div"),this.overlay.id="smartshield-warning-overlay",this.overlay.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: 100vh;\n      background: rgba(0, 0, 0, 0.9);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ";const i=this.generateWarningHTML(e,t,n);this.overlay.innerHTML=i,document.body.appendChild(this.overlay),this.addEventListeners()}generateWarningHTML(e,t,n){const i=this.getThreatColor(e);return`\n      <div style="\n        background: white;\n        border-radius: 12px;\n        padding: 32px;\n        max-width: 500px;\n        width: 90%;\n        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n        animation: slideIn 0.3s ease-out;\n      ">\n        <style>\n          @keyframes slideIn {\n            from { opacity: 0; transform: translateY(-20px); }\n            to { opacity: 1; transform: translateY(0); }\n          }\n        </style>\n        \n        <div style="text-align: center; margin-bottom: 24px;">\n          <div style="font-size: 48px; margin-bottom: 16px;">${this.getThreatIcon(e)}</div>\n          <h1 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; color: #dc2626;">\n            Security Warning\n          </h1>\n          <div style="\n            display: inline-block;\n            padding: 6px 16px;\n            border-radius: 20px;\n            color: white;\n            font-size: 12px;\n            font-weight: 600;\n            letter-spacing: 0.5px;\n            background: ${i};\n          ">\n            ${e.toUpperCase()} RISK\n          </div>\n        </div>\n\n        <div style="margin-bottom: 24px;">\n          <p style="font-size: 16px; color: #374151; margin-bottom: 16px; line-height: 1.5;">\n            SmartShield has detected potential security threats on this website:\n          </p>\n          \n          <div style="\n            background: #f3f4f6;\n            padding: 12px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            font-size: 14px;\n            word-break: break-all;\n            border-left: 4px solid #dc2626;\n          ">\n            <strong>URL:</strong> ${n}\n          </div>\n\n          <div style="margin-bottom: 20px;">\n            <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1f2937;">Detected Threats:</h3>\n            <ul style="margin: 0; padding-left: 20px;">\n              ${t.map(e=>`<li style="margin-bottom: 4px; color: #dc2626; font-size: 14px;">${e}</li>`).join("")}\n            </ul>\n          </div>\n\n          <div style="margin-bottom: 20px;">\n            <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1f2937;">Recommendations:</h3>\n            <ul style="margin: 0; padding-left: 20px;">\n              <li style="margin-bottom: 4px; color: #6b7280; font-size: 14px;">Do not enter personal information</li>\n              <li style="margin-bottom: 4px; color: #6b7280; font-size: 14px;">Do not download files from this site</li>\n              <li style="margin-bottom: 4px; color: #6b7280; font-size: 14px;">Verify the site's authenticity through other means</li>\n              <li style="margin-bottom: 4px; color: #6b7280; font-size: 14px;">Consider using a different website</li>\n            </ul>\n          </div>\n        </div>\n\n        <div style="display: flex; gap: 12px; margin-bottom: 20px;">\n          <button id="go-back-btn" style="\n            flex: 1;\n            padding: 12px 24px;\n            background: #3b82f6;\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n          ">\n            Go Back\n          </button>\n          <button id="proceed-btn" style="\n            flex: 1;\n            padding: 12px 24px;\n            background: #f3f4f6;\n            color: #374151;\n            border: 1px solid #d1d5db;\n            border-radius: 8px;\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n          ">\n            Proceed Anyway (Not Recommended)\n          </button>\n        </div>\n\n        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #e5e7eb;">\n          <p style="margin: 0; font-size: 12px; color: #6b7280;">\n            This warning is provided by SmartShield to protect your security.\n          </p>\n        </div>\n      </div>\n    `}getThreatColor(e){switch(e){case"high":return"#dc2626";case"medium":return"#f59e0b";case"low":return"#10b981";default:return"#6b7280"}}getThreatIcon(e){switch(e){case"high":return"⚠️";case"medium":return"⚡";case"low":return"ℹ️";default:return"❓"}}addEventListeners(){if(!this.overlay)return;const e=this.overlay.querySelector("#go-back-btn"),t=this.overlay.querySelector("#proceed-btn");e?.addEventListener("click",()=>{window.history.back(),this.hide()}),t?.addEventListener("click",()=>{this.hide(),chrome.runtime.sendMessage({action:"proceedToSite"})})}}class s{constructor(){this.widget=null,this.isVisible=!1,this.isMinimized=!1}show(){this.isVisible?this.toggle():(this.createWidget(),this.isVisible=!0)}hide(){this.widget&&(this.widget.remove(),this.widget=null,this.isVisible=!1,this.isMinimized=!1)}toggle(){this.isMinimized?this.expand():this.minimize()}createWidget(){this.widget=document.createElement("div"),this.widget.id="smartshield-chatbot-widget",this.widget.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 350px;\n      height: 500px;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);\n      z-index: 999998;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    ";const e=this.generateWidgetHTML();this.widget.innerHTML=e,document.body.appendChild(this.widget),this.addEventListeners()}generateWidgetHTML(){return`\n      <div style="\n        padding: 16px 20px;\n        background: #3b82f6;\n        color: white;\n        border-radius: 12px 12px 0 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        cursor: pointer;\n      " id="chatbot-header">\n        <div>\n          <h3 style="margin: 0; font-size: 16px; font-weight: 600;">SmartShield Assistant</h3>\n          <div style="display: flex; align-items: center; font-size: 12px;">\n            <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 6px;"></div>\n            Online\n          </div>\n        </div>\n        <button id="minimize-btn" style="\n          background: none;\n          border: none;\n          color: white;\n          font-size: 18px;\n          cursor: pointer;\n          padding: 4px;\n        ">−</button>\n      </div>\n\n      <div style="flex: 1; padding: 16px; overflow-y: auto; background: #f9fafb;" id="chatbot-messages">\n        <div style="margin-bottom: 16px; display: flex; justify-content: flex-start;">\n          <div style="max-width: 80%; padding: 12px 16px; background: white; color: #374151; border: 1px solid #e5e7eb; border-radius: 18px; border-bottom-left-radius: 4px;">\n            <div style="font-size: 14px; line-height: 1.4; margin-bottom: 4px;">\n              Hello! I'm SmartShield Assistant. I can help you understand phishing threats and security best practices. How can I assist you today?\n            </div>\n            <div style="font-size: 11px; opacity: 0.7;">${(new Date).toLocaleTimeString()}</div>\n          </div>\n        </div>\n      </div>\n\n      <div style="padding: 16px; background: white; border-radius: 0 0 12px 12px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; align-items: flex-end;" id="chatbot-input">\n        <textarea id="message-input" style="\n          flex: 1;\n          padding: 12px;\n          border: 1px solid #d1d5db;\n          border-radius: 20px;\n          font-size: 14px;\n          font-family: inherit;\n          resize: none;\n          outline: none;\n        " placeholder="Ask me about phishing protection..." rows="2"></textarea>\n        <button id="send-btn" style="\n          padding: 12px 20px;\n          background: #3b82f6;\n          color: white;\n          border: none;\n          border-radius: 20px;\n          font-size: 14px;\n          font-weight: 500;\n          cursor: pointer;\n        ">Send</button>\n      </div>\n    `}addEventListeners(){if(!this.widget)return;const e=this.widget.querySelector("#chatbot-header"),t=this.widget.querySelector("#minimize-btn"),n=this.widget.querySelector("#send-btn"),i=this.widget.querySelector("#message-input");e?.addEventListener("click",()=>{this.toggle()}),t?.addEventListener("click",e=>{e.stopPropagation(),this.toggle()}),n?.addEventListener("click",()=>{this.sendMessage()}),i?.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})}sendMessage(){const e=this.widget?.querySelector("#message-input"),t=this.widget?.querySelector("#chatbot-messages");if(!e||!t)return;const n=e.value.trim();n&&(this.addMessage(n,!0),e.value="",setTimeout(()=>{this.addMessage("I understand your question. Let me help you with that. This is a demo response from the SmartShield Assistant.",!1)},1e3))}addMessage(e,t){const n=this.widget?.querySelector("#chatbot-messages");if(!n)return;const i=document.createElement("div");i.style.cssText="margin-bottom: 16px; display: flex;",i.style.justifyContent=t?"flex-end":"flex-start";const s=document.createElement("div");s.style.cssText="\n      max-width: 80%;\n      padding: 12px 16px;\n      border-radius: 18px;\n      font-size: 14px;\n      line-height: 1.4;\n    ",s.style.cssText+=t?"\n        background: #3b82f6;\n        color: white;\n        border-bottom-right-radius: 4px;\n      ":"\n        background: white;\n        color: #374151;\n        border: 1px solid #e5e7eb;\n        border-bottom-left-radius: 4px;\n      ",s.innerHTML=`\n      <div style="margin-bottom: 4px;">${e}</div>\n      <div style="font-size: 11px; opacity: 0.7;">${(new Date).toLocaleTimeString()}</div>\n    `,i.appendChild(s),n.appendChild(i),n.scrollTop=n.scrollHeight}minimize(){if(!this.widget)return;this.widget.style.height="60px",this.widget.style.width="200px";const e=this.widget.querySelector("#chatbot-messages"),t=this.widget.querySelector("#chatbot-input");e&&(e.style.display="none"),t&&(t.style.display="none"),this.isMinimized=!0}expand(){if(!this.widget)return;this.widget.style.height="500px",this.widget.style.width="350px";const e=this.widget.querySelector("#chatbot-messages"),t=this.widget.querySelector("#chatbot-input");e&&(e.style.display="flex"),t&&(t.style.display="flex"),this.isMinimized=!1}}const o=new class{constructor(){this.isAnalyzing=!1,this.analysisResult=null,this.warningDisplay=null,this.chatbotWidget=null,this.config=null,this.initialize()}async initialize(){try{e.info("SmartShield content script initializing",{url:window.location.href,domain:window.location.hostname}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.onPageReady()):this.onPageReady(),chrome.runtime.onMessage.addListener((e,t,n)=>(this.handleMessage(e,t,n),!0)),this.observePageChanges()}catch(t){e.error("Failed to initialize content script",{error:t})}}async onPageReady(){try{if(this.config=await this.getConfig(),!this.config.enabled)return void e.info("SmartShield is disabled, skipping analysis");if(this.shouldSkipAnalysis())return void e.info("Skipping analysis for this page type");setTimeout(()=>{this.startAnalysis()},1e3)}catch(t){e.error("Failed to handle page ready",{error:t})}}shouldSkipAnalysis(){const e=window.location.href;if(e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return!0;if(e.startsWith("file://"))return!0;const t=document.contentType;return!(!t||t.includes("text/html"))||!!(document.body&&document.body.scrollHeight<100)}async startAnalysis(){if(this.isAnalyzing)e.debug("Analysis already in progress, skipping");else try{this.isAnalyzing=!0,e.info("Starting content analysis",{url:window.location.href});const i=await n.extractContent(),s=new t,o=await s.analyzeContent(i);let r=o;if(o.score>=.3&&o.score<=.7)try{const e=await this.sendToBackendForAnalysis(i);e&&(r=e)}catch(t){e.warn("Backend analysis failed, using local result",{error:t})}this.analysisResult=r,chrome.runtime.sendMessage({type:"ANALYSIS_RESULT",payload:{score:r.score,label:r.label,reasons:r.reasons,url:window.location.href,timestamp:Date.now(),model:r.model||"local",provider:r.provider||"local"}}),r.score>=this.config.highThreshold&&await this.showWarning(r),r.score>=this.config.lowThreshold&&await this.showChatbotWidget(r),e.info("Content analysis completed",{score:r.score,label:r.label,reasons:r.reasons.length,model:r.model||"local",provider:r.provider||"local"})}catch(t){e.error("Failed to analyze content",{error:t})}finally{this.isAnalyzing=!1}}async showWarning(t){try{this.warningDisplay&&this.warningDisplay.hide(),this.warningDisplay=new i,this.warningDisplay.show(t.score>=.8?"high":t.score>=.5?"medium":"low",t.reasons||["Suspicious content detected"],window.location.href),chrome.runtime.sendMessage({type:"ANALYTICS_EVENT",payload:{event:"warning_shown",data:{score:t.score,url:window.location.href,domain:window.location.hostname}}})}catch(t){e.error("Failed to show warning",{error:t})}}async showChatbotWidget(t){try{this.chatbotWidget&&this.chatbotWidget.hide(),this.chatbotWidget=new s,this.chatbotWidget.show()}catch(t){e.error("Failed to show chatbot widget",{error:t})}}handleMessage(t,n,i){try{switch(e.debug("Content script message received",{message:t}),t.type){case"START_ANALYSIS":this.startAnalysis(),i({success:!0});break;case"GET_ANALYSIS_RESULT":i({result:this.analysisResult});break;case"SHOW_WARNING":this.analysisResult&&this.showWarning(this.analysisResult),i({success:!0});break;case"HIDE_WARNING":this.hideWarning(),i({success:!0});break;case"TOGGLE_CHATBOT":this.toggleChatbot(),i({success:!0});break;default:e.warn("Unknown message type",{type:t.type}),i({success:!1,error:"Unknown message type"})}}catch(t){e.error("Failed to handle message",{error:t}),i({success:!1,error:t instanceof Error?t.message:"Unknown error"})}}hideWarning(){this.warningDisplay&&this.warningDisplay.hide()}toggleChatbot(){this.chatbotWidget?this.chatbotWidget.toggle():this.analysisResult&&this.showChatbotWidget(this.analysisResult)}observePageChanges(){let t=window.location.href;new MutationObserver(()=>{window.location.href!==t&&(t=window.location.href,e.info("Page navigation detected",{url:t}),this.resetState(),setTimeout(()=>{this.startAnalysis()},1e3))}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("popstate",()=>{e.info("Browser navigation detected",{url:window.location.href}),this.resetState(),setTimeout(()=>{this.startAnalysis()},1e3)})}async sendToBackendForAnalysis(t){try{const n=await fetch("http://localhost:4000/api/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({snapshot_hash:this.generateContentHash(t.text),sanitized_text:t.text.substring(0,2e3),metadata:{url:window.location.href,timestamp:Date.now(),domain:window.location.hostname,title:document.title}})});if(!n.ok)throw new Error(`Backend request failed: ${n.status}`);const i=await n.json();return e.info("Backend analysis completed",{score:i.score,label:i.label,model:i.model,provider:i.provider}),{score:i.score,label:i.label,reasons:i.reasons||[],explanation:i.explain||"",confidence:i.confidence||.5,model:i.model,provider:i.provider}}catch(t){throw e.error("Backend analysis failed",{error:t}),t}}generateContentHash(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t).toString(36)}resetState(){this.isAnalyzing=!1,this.analysisResult=null,this.warningDisplay&&(this.warningDisplay.hide(),this.warningDisplay=null),this.chatbotWidget&&(this.chatbotWidget.hide(),this.chatbotWidget=null)}async getConfig(){return new Promise(t=>{chrome.runtime.sendMessage({type:"GET_CONFIG"},n=>{chrome.runtime.lastError?(e.error("Failed to get config",{error:chrome.runtime.lastError}),t(this.getDefaultConfig())):t(n.config||this.getDefaultConfig())})})}getDefaultConfig(){return{enabled:!0,lowThreshold:.3,highThreshold:.7,reportThreshold:.8,privacyMode:!0,notifications:!0}}};window.smartShield=o})();